# GDB MCP Server integration via FastMCP 2.x

python
import threading
import traceback

try:
    import gdb  # provided by GDB's Python
except Exception as e:
    raise RuntimeError("This script requires GDB with Python support") from e

_mcp_thread = None
_mcp_running = False


def _run_gdb_command(cmd: str) -> str:
    """Execute a GDB command on GDB's main thread and return output.

    No timeout handling is provided.
    """
    result = {"out": "", "err": None, "done": False}
    cond = threading.Condition()

    def _do_exec():
        try:
            out = gdb.execute(cmd, to_string=True)
            with cond:
                result["out"] = out
                result["done"] = True
                cond.notify_all()
        except Exception as ex:
            with cond:
                result["err"] = f"{type(ex).__name__}: {ex}"
                result["done"] = True
                cond.notify_all()

    gdb.post_event(_do_exec)
    with cond:
        while not result["done"]:
            cond.wait(timeout=0.05)
    if result["err"]:
        return f"ERROR: {result['err']}"
    return result["out"]


def _build_fastmcp_app():
    """Construct and return a FastMCP server instance."""
    try:
        from fastmcp import FastMCP
    except Exception as e:
        gdb.write(f"[mcp] Failed to import fastmcp: {e}\n")
        gdb.write("[mcp] Please install FastMCP 2.x: python3 -m pip install 'fastmcp>=2.0'\n")
        return None

    mcp = FastMCP("gdb-mcp")

    @mcp.tool
    def gdb_command(command: str) -> str:
        """Run a GDB command and return its output.

        Args:
            command: The GDB command to execute (e.g., 'info registers', 'backtrace')

        Returns:
            The output of the GDB command or an error message
        """
        return _run_gdb_command(command)

    return mcp


class McpServerCommand(gdb.Command):
    """Start a FastMCP HTTP server inside GDB.

Usage:
  mcp-server <host> <port>

Example:
  mcp-server 127.0.0.1 3333
    """

    def __init__(self):
        super(McpServerCommand, self).__init__("mcp-server", gdb.COMMAND_USER)

    def invoke(self, arg, from_tty):
        global _mcp_thread, _mcp_running
        argv = gdb.string_to_argv(arg)
        if len(argv) != 2:
            raise gdb.GdbError("usage: mcp-server <host> <port>")
        host, port_str = argv[0], argv[1]
        try:
            port = int(port_str)
        except ValueError:
            raise gdb.GdbError("port must be an integer")

        if _mcp_running:
            gdb.write("[mcp] Server already running\n")
            return

        mcp = _build_fastmcp_app()
        if mcp is None:
            raise gdb.GdbError("Failed to initialize FastMCP server; see messages above")

        def _serve():
            global _mcp_running
            _mcp_running = True
            try:
                gdb.write(f"[mcp] Starting HTTP server on {host}:{port}...\n")
                mcp.run(transport="http", host=host, port=port)
            except Exception:
                traceback.print_exc()
            finally:
                _mcp_running = False
                gdb.write("[mcp] Server stopped\n")

        _mcp_thread = threading.Thread(target=_serve, name="gdb-mcp-http", daemon=True)
        _mcp_thread.start()
        gdb.write("[mcp] Server launched in background.\n")


McpServerCommand()
end

